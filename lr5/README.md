# Лабораторная работа 5 - Система авторизации с журналом посещений

## Описание
Flask-приложение с системой авторизации, ролевым доступом и журналом посещений с отчётами.

## Основные функции

### 1. Система авторизации
- **Декоратор check_rights**: Контролирует доступ к функциям на основе ролей пользователей
- **Роли**: Администратор и Пользователь с разными правами доступа
- **Права доступа**:
  - Администратор: создание, редактирование, просмотр, удаление пользователей; просмотр отчётов
  - Пользователь: редактирование собственного профиля, просмотр собственных данных

### 2. Журнал посещений
- **Автоматическое логирование**: Все посещения страниц записываются в базу данных
- **Tracking анонимных пользователей**: Записываются посещения неаутентифицированных пользователей
- **Модель VisitLog**: Содержит информацию о странице, пользователе и времени посещения

### 3. Статистические отчёты
- **Отчёт по страницам**: Статистика посещаемости страниц
- **Отчёт по пользователям**: Активность пользователей
- **Пагинация**: Отчёты разделены на страницы для удобства просмотра
- **Экспорт в CSV**: Возможность скачивания отчётов в формате CSV

### 4. Пользовательский интерфейс
- **Условное отображение**: Кнопки и меню отображаются только при наличии соответствующих прав
- **Bootstrap 5**: Адаптивный дизайн с современным интерфейсом
- **Навигация**: Меню изменяется в зависимости от роли пользователя

## Структура проекта

```
lr5/
├── app/
│   ├── __init__.py          # Фабрика приложения с конфигурацией
│   ├── models.py            # Модели User, Role, VisitLog
│   ├── forms.py             # WTForms для валидации данных
│   ├── auth_utils.py        # Декоратор check_rights и вспомогательные функции
│   ├── auth.py              # Blueprint аутентификации
│   ├── routes.py            # Основные маршруты пользователей
│   └── reports.py           # Blueprint отчётов с CSV экспортом
├── templates/               # HTML шаблоны с условным отображением
├── tests/                   # Тесты для всех компонентов
├── config.py               # Конфигурация приложения
├── app.py                  # Точка входа
└── requirements.txt        # Зависимости
```

## Ключевые особенности реализации

### Декоратор check_rights
```python
@check_rights('view_users')
def users_list():
    # Только для пользователей с правом view_users
    pass
```

### Автоматическое логирование посещений
```python
@app.before_request
def log_visit():
    visit_log = VisitLog(
        page=request.path,
        user_id=current_user.id if current_user.is_authenticated else None
    )
    db.session.add(visit_log)
    db.session.commit()
```

### Условное отображение в шаблонах
```html
{% if can_user_access('create_users') %}
<a href="{{ url_for('main.create_user') }}" class="btn btn-primary">Создать пользователя</a>
{% endif %}
```

## Система прав доступа

### Администратор
- Создание, редактирование, просмотр, удаление пользователей
- Просмотр всех отчётов и статистики
- Доступ ко всем функциям системы

### Пользователь
- Редактирование собственного профиля (кроме роли)
- Просмотр собственных данных и посещений
- Смена собственного пароля

## Тестирование
Реализован комплекс тестов:
- **test_auth_and_permissions.py**: Тесты аутентификации и авторизации
- **test_models_and_utils.py**: Тесты моделей данных и утилит
- **test_forms.py**: Тесты форм и валидации

## Запуск приложения

1. Установка зависимостей:
```bash
pip install -r requirements.txt
```

2. Запуск приложения:
```bash
python app.py
```

3. Пользователи по умолчанию:
- **admin** / **admin123** (Администратор)
- **user** / **user123** (Пользователь)

## Технические детали

- **Flask 2.3.3**: Веб-фреймворк
- **SQLAlchemy 3.0.5**: ORM для работы с базой данных
- **Flask-Login 0.6.3**: Управление сессиями пользователей
- **WTForms 3.0.1**: Валидация форм
- **Bootstrap 5**: CSS фреймворк для интерфейса

## Реализованные требования

✅ **Авторизация пользователей** - система ролей и прав доступа  
✅ **Декоратор check_rights** - контроль доступа к функциям  
✅ **Проверка прав на действия** - разграничение доступа по ролям  
✅ **Перенаправление при недостатке прав** - с информативными сообщениями  
✅ **Условное отображение кнопок** - UI адаптируется под права пользователя  
✅ **Журнал посещений** - автоматическое логирование всех запросов  
✅ **Статистические отчёты** - с пагинацией и экспортом в CSV  
✅ **Тесты функционала** - комплексное тестирование всех компонентов